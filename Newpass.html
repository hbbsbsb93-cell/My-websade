<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xaqiiji Kaydinta | New Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-gradient { background: linear-gradient(90deg, #13ec5b 0%, #0fb847 100%); }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #13ec5b;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#0f172a] min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-md bg-[#1e293b] rounded-3xl shadow-2xl p-8 border border-gray-700">
        <div class="flex justify-center mb-6">
            <div class="bg-green-500/10 p-4 rounded-full">
                <svg class="w-10 h-10 text-[#13ec5b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04M12 21.355r-1.158-8.412a1.35 1.35 0 00-1.272-1.272l-8.412-1.158m1.158 8.412a1.35 1.35 0 001.272 1.272l8.412 1.158"></path>
                </svg>
            </div>
        </div>

        <h2 class="text-white text-2xl font-extrabold text-center mb-2">Tallaabada u dambaysa</h2>
        <p class="text-gray-400 text-center text-sm mb-8 px-4">
            Koodhkii waa la xaqiijiyey. Hadda, Google waxay Gmail-kaaga u soo diraysaa link-ga rasmiga ah si aad password-ka u beddelato.
        </p>

        <button id="reset-btn" class="w-full btn-gradient text-black font-bold py-4 rounded-2xl shadow-lg shadow-green-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2">
            <span id="btn-text">U dir Gmail Reset Link</span>
            <div id="loader" class="loader hidden"></div>
        </button>

        <div id="status-msg" class="mt-6 text-sm text-center hidden"></div>

        <div class="mt-8 pt-6 border-t border-gray-700 text-center">
            <p class="text-gray-500 text-xs italic">
                Amaan: Password-kaaga cusub waxaa toos u kaydinaya Google Firebase.
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Firebase Config-gaadii rasmiga ahayd
        const firebaseConfig = {
            apiKey: "AIzaSyCk4S0S7dvZrTn6Q4OISL1WZtNHXRrWk",
            authDomain: "my-websade.firebaseapp.com",
            projectId: "my-websade",
            appId: "1:34681878474:web:5d11bb422bf74008dcc133"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // SECURITY CHECK: Hubi in qofku soo maray OTP Verification
        const isVerified = sessionStorage.getItem('isVerified');
        const userEmail = sessionStorage.getItem('resetEmail');

        if (!isVerified || !userEmail) {
            window.location.href = "email.html";
        }

        const resetBtn = document.getElementById('reset-btn');
        const loader = document.getElementById('loader');
        const btnText = document.getElementById('btn-text');
        const statusMsg = document.getElementById('status-msg');

        resetBtn.addEventListener('click', async () => {
            resetBtn.disabled = true;
            loader.classList.remove('hidden');
            btnText.innerText = "Waa la dirayaa...";

            try {
                // Google Password Reset Action
                await sendPasswordResetEmail(auth, userEmail);
                
                statusMsg.innerHTML = `<span class="text-green-400 font-medium">✅ Link-ga waa la soo diray! Hubi Gmail-kaaga.</span>`;
                statusMsg.classList.remove('hidden');
                
                // Nadiifi session-ka markuu dhameeyo
                sessionStorage.clear();

                setTimeout(() => {
                    alert("Google waxay kuu soo dirtay email. Fadlan riix link-ga email-ka ku jira si aad password-ka u beddelato.");
                    window.location.href = "login.html";
                }, 3000);

            } catch (error) {
                resetBtn.disabled = false;
                loader.classList.add('hidden');
                btnText.innerText = "U dir Gmail Reset Link";
                statusMsg.innerHTML = `<span class="text-red-400">❌ Cilad: ${error.message}</span>`;
                statusMsg.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
