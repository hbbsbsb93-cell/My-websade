<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Nature's Glow - Verify OTP</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
    <style type="text/tailwindcss">
        :root {
            --brand-green: #2D5A27;
            --brand-cream: #FDFBF7;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--brand-cream); margin: 0; padding: 0; }
        .main-container { @apply min-h-screen flex items-center justify-center p-4 relative; }
        .card { @apply w-full max-w-sm bg-white rounded-[2.5rem] shadow-2xl p-8 md:p-10 border border-gray-100 flex flex-col items-center z-10; }
        .otp-input { @apply w-10 h-12 md:w-12 md:h-14 text-center text-xl font-bold border-2 border-gray-100 rounded-xl focus:border-[var(--brand-green)] focus:ring-0 transition-all outline-none bg-gray-50; }
        .verify-btn { @apply w-full bg-[var(--brand-green)] hover:bg-[#23461e] text-white font-semibold py-4 rounded-2xl transition-all shadow-lg shadow-green-900/20 active:scale-[0.98]; }
        /* Loading spinner */
        .spinner { width: 45px; height: 45px; border: 5px solid #e5e7eb; border-top: 5px solid #2D5A27; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-container">
        <div id="verify-card" class="card">
            <div class="flex flex-col items-center mb-8">
                <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center mb-3">
                    <span class="material-symbols-outlined text-[var(--brand-green)]">spa</span>
                </div>
                <h2 class="font-serif text-2xl font-bold text-[var(--brand-green)] tracking-tight">Nature's Glow</h2>
            </div>

            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Verify OTP</h1>
                <p class="text-sm text-gray-500 px-4">Waxaan koodh u dirnay: <br><span id="display-email" class="font-semibold text-gray-800">---</span></p>
            </div>

            <form id="otp-form" class="w-full space-y-8">
                <div class="flex justify-center gap-2 md:gap-3">
                    <input class="otp-input" maxlength="1" type="text" inputmode="numeric" required/>
                    <input class="otp-input" maxlength="1" type="text" inputmode="numeric" required/>
                    <input class="otp-input" maxlength="1" type="text" inputmode="numeric" required/>
                    <input class="otp-input" maxlength="1" type="text" inputmode="numeric" required/>
                    <input class="otp-input" maxlength="1" type="text" inputmode="numeric" required/>
                    <input class="otp-input" maxlength="1" type="text" inputmode="numeric" required/>
                </div>
                <button id="verify-btn" class="verify-btn" type="submit">Verify & Register</button>
            </form>
        </div>

        <div id="loader" class="fixed inset-0 bg-white/80 z-[500] hidden flex flex-col items-center justify-center backdrop-blur-sm">
            <div class="spinner"></div>
            <p id="loader-text" class="mt-4 text-[var(--brand-green)] font-bold animate-pulse">Hubinta koodhka...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCk4S0S7dvZrTN6q4oISLIWIXZNtHXRrvk",
            authDomain: "my-websade.firebaseapp.com",
            projectId: "my-websade",
            appId: "1:34681878474:web:5d11bb422bf74008cdc133"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const actualOTP = sessionStorage.getItem('generatedOTP');
        const pendingEmail = sessionStorage.getItem('pendingEmail');
        const pendingPassword = sessionStorage.getItem('pendingPassword');

        if (pendingEmail) document.getElementById('display-email').innerText = pendingEmail;

        const inputs = document.querySelectorAll('.otp-input');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');

        // Auto-focus logic
        inputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (input.value && index < inputs.length - 1) inputs[index + 1].focus();
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !input.value && index > 0) inputs[index - 1].focus();
            });
        });

        // Hubinta iyo Diiwaangelinta
        document.getElementById('otp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            let enteredCode = "";
            inputs.forEach(input => enteredCode += input.value);

            if (enteredCode === actualOTP) {
                // Bilow Loader-ka
                loader.classList.remove('hidden');
                loaderText.innerText = "Koodhku waa sax! Diiwaangelinta ayaa socota...";

                try {
                    // 1. Ku dar Firebase Auth
                    await createUserWithEmailAndPassword(auth, pendingEmail, pendingPassword);
                    
                    loaderText.innerText = "Guul! Koontadaada waa la sameeyay...";
                    sessionStorage.clear();
                    
                    setTimeout(() => {
                        window.location.href = "home.html"; // U weeci bogga guriga
                    }, 1500);

                } catch (error) {
                    loader.classList.add('hidden');
                    alert("Cillad: Diiwaangelintu way fashilantay. " + error.message);
                }
            } else {
                alert("‚ùå Koodhku waa khaldan yahay! Fadlan mar kale iska hubi email-kaagii.");
            }
        });
    </script>
</body>
</html>
